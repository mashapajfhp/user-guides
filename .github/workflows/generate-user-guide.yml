name: Generate User Guide

on:
  workflow_dispatch:
    inputs:
      feature_slug:
        description: 'Feature slug with underscores (e.g., daily_wage_calculator)'
        required: true
        type: string
      feature_name:
        description: 'Human-readable feature name (e.g., Daily Wage Calculator)'
        required: true
        type: string
      jira_report_path:
        description: 'Path to Jira analysis report'
        required: false
        type: string
      zendesk_report_path:
        description: 'Path to Zendesk analysis report'
        required: false
        type: string
      validation_artifact_path:
        description: 'Path to validation artifact (e.g., interface-validation-20409366764)'
        required: false
        type: string
      validation_artifact_url:
        description: 'URL to download validation artifact'
        required: false
        type: string
      clean_feature_name:
        description: 'Feature name with hyphens (e.g., daily-wage-calculator)'
        required: false
        type: string

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  N8N_CALLBACK_URL: ${{ secrets.N8N_CALLBACK_URL }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  generate:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version number
        id: version
        run: |
          FEATURE_SLUG="${{ inputs.feature_slug }}"
          OUTPUT_DIR="outputs/${FEATURE_SLUG}"

          # Find existing versions
          if [ -d "$OUTPUT_DIR" ]; then
            LATEST_VERSION=$(ls -1 "$OUTPUT_DIR"/user-guide_v*.html 2>/dev/null | sed 's/.*_v\([0-9]*\)\.html/\1/' | sort -n | tail -1)
            if [ -z "$LATEST_VERSION" ]; then
              VERSION=1
            else
              VERSION=$((LATEST_VERSION + 1))
            fi
          else
            VERSION=1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìä Version: v$VERSION"

      - name: Verify input files exist
        id: verify
        run: |
          echo "üîç Checking input files for: ${{ inputs.feature_slug }}"
          START_TIME=$(date +%s)

          # Check Zendesk report
          ZENDESK_FILE=$(ls -t reports/zendesk/${{ inputs.feature_slug }}/versions/zendesk_md_*.md 2>/dev/null | head -1)
          if [ -z "$ZENDESK_FILE" ]; then
            echo "‚ùå Zendesk report not found"
            exit 1
          fi
          echo "‚úÖ Zendesk: $ZENDESK_FILE"
          echo "zendesk_file=$ZENDESK_FILE" >> $GITHUB_OUTPUT

          # Check Jira report
          JIRA_FILE=$(ls -t reports/jira/${{ inputs.feature_slug }}/versions/v1/runs/jira-analysis_*.md 2>/dev/null | head -1)
          if [ -z "$JIRA_FILE" ]; then
            echo "‚ùå Jira report not found"
            exit 1
          fi
          echo "‚úÖ Jira: $JIRA_FILE"
          echo "jira_file=$JIRA_FILE" >> $GITHUB_OUTPUT

          # Check validation files
          if [ ! -f ".validation/output/result.json" ]; then
            echo "‚ùå Validation result.json not found"
            exit 1
          fi
          echo "‚úÖ Validation: .validation/output/result.json"

          # Check screenshots
          SCREENSHOT_COUNT=$(ls .validation/output/screenshots/*.png 2>/dev/null | wc -l | tr -d ' ')
          if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
            echo "‚ùå No screenshots found"
            exit 1
          fi
          echo "‚úÖ Screenshots: $SCREENSHOT_COUNT files"
          echo "screenshot_count=$SCREENSHOT_COUNT" >> $GITHUB_OUTPUT

          # Check template
          if [ ! -f "clean-template-reorganized.html" ]; then
            echo "‚ùå Template not found"
            exit 1
          fi
          echo "‚úÖ Template: clean-template-reorganized.html"

          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT

      - name: Preprocess input files
        id: preprocess
        env:
          FEATURE_SLUG: ${{ inputs.feature_slug }}
        run: |
          echo "üìÇ Preprocessing input files for: ${FEATURE_SLUG}"

          # Create temp directory for consolidated input
          mkdir -p .generation-input

          # 1. Get latest Zendesk report
          ZENDESK_FILE=$(ls -t reports/zendesk/${FEATURE_SLUG}/versions/zendesk_md_*.md 2>/dev/null | head -1)
          echo "üìÑ Zendesk: $ZENDESK_FILE"
          cp "$ZENDESK_FILE" .generation-input/zendesk-report.md

          # 2. Get latest Jira report
          JIRA_FILE=$(ls -t reports/jira/${FEATURE_SLUG}/versions/v1/runs/jira-analysis_*.md 2>/dev/null | head -1)
          echo "üìÑ Jira: $JIRA_FILE"
          cp "$JIRA_FILE" .generation-input/jira-report.md

          # 3. Copy validation results
          cp .validation/output/result.json .generation-input/validation-result.json
          if [ -f ".validation/output/pw_result.json" ]; then
            cp .validation/output/pw_result.json .generation-input/pw-result.json
          fi

          # 4. Copy template
          cp clean-template-reorganized.html .generation-input/template.html

          # 5. List screenshots
          ls -1 .validation/output/screenshots/*.png > .generation-input/screenshot-list.txt 2>/dev/null || echo "No screenshots" > .generation-input/screenshot-list.txt

          # 6. Create consolidated prompt file with all content
          cat > .generation-input/full-prompt.md << 'PROMPT_END'
          # User Guide Generation Task

          Generate a complete HTML user guide by filling in the template with content from the source files below.

          ## Instructions
          1. Read the ZENDESK REPORT for feature documentation and help content
          2. Read the JIRA REPORT for known issues, limitations, and customer requests
          3. Read the VALIDATION RESULT for verified interface elements and screenshots
          4. Use the TEMPLATE structure - replace all [PLACEHOLDER] text with real content
          5. Output ONLY the final HTML - no explanations, no markdown code blocks

          PROMPT_END

          echo -e "\n---\n## ZENDESK REPORT\n---\n" >> .generation-input/full-prompt.md
          cat .generation-input/zendesk-report.md >> .generation-input/full-prompt.md

          echo -e "\n---\n## JIRA REPORT\n---\n" >> .generation-input/full-prompt.md
          cat .generation-input/jira-report.md >> .generation-input/full-prompt.md

          echo -e "\n---\n## VALIDATION RESULT\n---\n" >> .generation-input/full-prompt.md
          cat .generation-input/validation-result.json >> .generation-input/full-prompt.md

          echo -e "\n---\n## AVAILABLE SCREENSHOTS\n---\n" >> .generation-input/full-prompt.md
          cat .generation-input/screenshot-list.txt >> .generation-input/full-prompt.md

          echo -e "\n---\n## HTML TEMPLATE (fill this in)\n---\n" >> .generation-input/full-prompt.md
          cat .generation-input/template.html >> .generation-input/full-prompt.md

          # Get file size
          PROMPT_SIZE=$(wc -c < .generation-input/full-prompt.md | tr -d ' ')
          echo "üìä Total prompt size: ${PROMPT_SIZE} bytes"
          echo "prompt_size=$PROMPT_SIZE" >> $GITHUB_OUTPUT

          echo "‚úÖ Preprocessing complete"

      - name: Generate User Guide
        timeout-minutes: 20
        env:
          FEATURE_SLUG: ${{ inputs.feature_slug }}
          FEATURE_NAME: ${{ inputs.feature_name }}
        run: |
          # Normalize API key (remove any whitespace/newlines)
          export ANTHROPIC_API_KEY=$(echo "$ANTHROPIC_API_KEY" | tr -d '[:space:]')

          VERSION="${{ steps.version.outputs.version }}"
          echo "üìù Generating user guide v$VERSION for: ${FEATURE_SLUG} (${FEATURE_NAME})"

          # Create output directory
          mkdir -p "outputs/${FEATURE_SLUG}/screenshots"

          # Copy screenshots to output
          cp .validation/output/screenshots/*.png "outputs/${FEATURE_SLUG}/screenshots/" 2>/dev/null || echo "No screenshots to copy"

          # Run claude (step-level timeout-minutes: 20 handles timeout on macOS)
          echo "‚è±Ô∏è Starting Claude generation..."
          echo "üìÑ Input prompt size: ${{ steps.preprocess.outputs.prompt_size }} bytes"

          # Pass prompt as argument to claude --print
          claude --print "$(cat .generation-input/full-prompt.md)" > "outputs/${FEATURE_SLUG}/user-guide_v${VERSION}.html"

          # Verify output was created
          OUTPUT_FILE="outputs/${FEATURE_SLUG}/user-guide_v${VERSION}.html"
          if [ -f "$OUTPUT_FILE" ] && [ -s "$OUTPUT_FILE" ]; then
            OUTPUT_SIZE=$(wc -c < "$OUTPUT_FILE" | tr -d ' ')
            echo "‚úÖ User guide generated: ${OUTPUT_SIZE} bytes"
          else
            echo "‚ùå Output file is empty or missing"
            exit 1
          fi

      - name: Commit and push user guide
        id: commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FEATURE_SLUG="${{ inputs.feature_slug }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add outputs/${FEATURE_SLUG}/ || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Generate user guide v${VERSION} for ${FEATURE_SLUG}

            ü§ñ Generated with Claude Code"
            git pull --rebase origin main
            git push
            echo "‚úÖ User guide committed and pushed"
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

          # Set output paths
          FILE_PATH="outputs/${FEATURE_SLUG}/user-guide_v${VERSION}.html"
          GITHUB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${FILE_PATH}"
          JIRA_GITHUB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${{ steps.verify.outputs.jira_file }}"
          ZENDESK_GITHUB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${{ steps.verify.outputs.zendesk_file }}"

          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          echo "github_url=$GITHUB_URL" >> $GITHUB_OUTPUT
          echo "jira_github_url=$JIRA_GITHUB_URL" >> $GITHUB_OUTPUT
          echo "zendesk_github_url=$ZENDESK_GITHUB_URL" >> $GITHUB_OUTPUT

      - name: Calculate generation duration
        id: duration
        run: |
          START_TIME="${{ steps.verify.outputs.start_time }}"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "‚è±Ô∏è Generation took ${DURATION} seconds"

      - name: Count validated claims
        id: claims
        run: |
          if [ -f ".validation/output/result.json" ]; then
            CLAIMS_COUNT=$(cat .validation/output/result.json | python3 -c "import sys, json; d=json.load(sys.stdin); print(len(d.get('validated_claims', [])))" 2>/dev/null || echo "0")
          else
            CLAIMS_COUNT=0
          fi
          echo "claims_count=$CLAIMS_COUNT" >> $GITHUB_OUTPUT
          echo "üìã Validated claims: $CLAIMS_COUNT"

      - name: Insert into Supabase
        if: steps.commit.outputs.committed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          curl -X POST "${{ env.SUPABASE_URL }}/rest/v1/user_guides" \
            -H "apikey: ${{ env.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{
              "feature_slug": "${{ inputs.feature_slug }}",
              "feature_name": "${{ inputs.feature_name }}",
              "version": '"$VERSION"',
              "file_path": "${{ steps.commit.outputs.file_path }}",
              "github_url": "${{ steps.commit.outputs.github_url }}",
              "jira_report_path": "${{ inputs.jira_report_path }}",
              "jira_report_github_url": "${{ steps.commit.outputs.jira_github_url }}",
              "zendesk_report_path": "${{ inputs.zendesk_report_path }}",
              "zendesk_report_github_url": "${{ steps.commit.outputs.zendesk_github_url }}",
              "validation_artifact_path": "${{ inputs.validation_artifact_path }}",
              "validation_artifact_url": "${{ inputs.validation_artifact_url }}",
              "screenshot_count": ${{ steps.verify.outputs.screenshot_count }},
              "validated_claims_count": ${{ steps.claims.outputs.claims_count }},
              "status": "generated",
              "generated_by": "claude-haiku",
              "generation_duration_seconds": ${{ steps.duration.outputs.duration }}
            }'

          echo "‚úÖ Inserted into Supabase"

      # TODO: Uncomment when Slack webhook is approved
      # - name: Send Slack notification
      #   if: always()
      #   run: |
      #     VERSION="${{ steps.version.outputs.version }}"
      #     STATUS="${{ job.status }}"
      #
      #     if [ "$STATUS" = "success" ]; then
      #       EMOJI="‚úÖ"
      #       COLOR="#36a64f"
      #       MESSAGE="User guide v${VERSION} generated successfully!"
      #     else
      #       EMOJI="‚ùå"
      #       COLOR="#ff0000"
      #       MESSAGE="User guide generation failed"
      #     fi
      #
      #     curl -X POST "${{ env.SLACK_WEBHOOK_URL }}" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "attachments": [{
      #           "color": "'"$COLOR"'",
      #           "blocks": [
      #             {
      #               "type": "header",
      #               "text": {
      #                 "type": "plain_text",
      #                 "text": "'"$EMOJI"' User Guide Generation",
      #                 "emoji": true
      #               }
      #             },
      #             {
      #               "type": "section",
      #               "fields": [
      #                 {"type": "mrkdwn", "text": "*Feature:*\n${{ inputs.feature_name }}"},
      #                 {"type": "mrkdwn", "text": "*Version:*\nv'"$VERSION"'"},
      #                 {"type": "mrkdwn", "text": "*Screenshots:*\n${{ steps.verify.outputs.screenshot_count }}"},
      #                 {"type": "mrkdwn", "text": "*Duration:*\n${{ steps.duration.outputs.duration }}s"}
      #               ]
      #             },
      #             {
      #               "type": "section",
      #               "text": {
      #                 "type": "mrkdwn",
      #                 "text": "*GitHub URL:*\n<${{ steps.commit.outputs.github_url }}|View User Guide>"
      #               }
      #             }
      #           ]
      #         }]
      #       }' || echo "Slack notification failed (non-critical)"

      - name: Callback to n8n
        if: env.N8N_CALLBACK_URL != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          curl -X POST "${{ env.N8N_CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "${{ job.status }}",
              "feature_slug": "${{ inputs.feature_slug }}",
              "feature_name": "${{ inputs.feature_name }}",
              "version": '"$VERSION"',
              "file_path": "${{ steps.commit.outputs.file_path }}",
              "github_url": "${{ steps.commit.outputs.github_url }}",
              "screenshot_count": ${{ steps.verify.outputs.screenshot_count }},
              "validated_claims_count": ${{ steps.claims.outputs.claims_count }},
              "generation_duration_seconds": ${{ steps.duration.outputs.duration }}
            }' || echo "n8n callback failed (non-critical)"

      - name: Output result
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "üéâ User guide generation complete!"
          echo "üìÅ Output: outputs/${{ inputs.feature_slug }}/user-guide_v${VERSION}.html"
          echo "üîó GitHub URL: ${{ steps.commit.outputs.github_url }}"
          echo "üìä Screenshots: ${{ steps.verify.outputs.screenshot_count }}"
          echo "üìã Validated claims: ${{ steps.claims.outputs.claims_count }}"
          echo "‚è±Ô∏è Duration: ${{ steps.duration.outputs.duration }}s"
