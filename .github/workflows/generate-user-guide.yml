name: Generate User Guide

on:
  workflow_dispatch:
    inputs:
      feature_slug:
        description: 'Feature slug with underscores (e.g., daily_wage_calculator)'
        required: true
        type: string
      feature_name:
        description: 'Human-readable feature name (e.g., Daily Wage Calculator)'
        required: true
        type: string
      jira_report_path:
        description: 'Path to Jira analysis report'
        required: false
        type: string
      zendesk_report_path:
        description: 'Path to Zendesk analysis report'
        required: false
        type: string
      validation_artifact_path:
        description: 'Path to validation artifact (e.g., interface-validation-20409366764)'
        required: false
        type: string
      validation_artifact_url:
        description: 'URL to download validation artifact'
        required: false
        type: string

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  N8N_CALLBACK_URL: ${{ secrets.N8N_CALLBACK_URL }}

jobs:
  generate:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version number
        id: version
        run: |
          FEATURE_SLUG="${{ inputs.feature_slug }}"
          OUTPUT_DIR="outputs/${FEATURE_SLUG}"

          # Find existing versions
          if [ -d "$OUTPUT_DIR" ]; then
            LATEST_VERSION=$(ls -1 "$OUTPUT_DIR"/user-guide_v*.html 2>/dev/null | sed 's/.*_v\([0-9]*\)\.html/\1/' | sort -n | tail -1)
            if [ -z "$LATEST_VERSION" ]; then
              VERSION=1
            else
              VERSION=$((LATEST_VERSION + 1))
            fi
          else
            VERSION=1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìä Version: v$VERSION"

      - name: Verify input files exist
        id: verify
        run: |
          echo "üîç Checking input files for: ${{ inputs.feature_slug }}"
          START_TIME=$(date +%s)

          # Check Zendesk report
          ZENDESK_FILE=$(ls -t reports/zendesk/${{ inputs.feature_slug }}/versions/zendesk_md_*.md 2>/dev/null | head -1)
          if [ -z "$ZENDESK_FILE" ]; then
            echo "‚ùå Zendesk report not found"
            exit 1
          fi
          echo "‚úÖ Zendesk: $ZENDESK_FILE"
          echo "zendesk_file=$ZENDESK_FILE" >> $GITHUB_OUTPUT

          # Check Jira report
          JIRA_FILE=$(ls -t reports/jira/${{ inputs.feature_slug }}/versions/v1/runs/jira-analysis_*.md 2>/dev/null | head -1)
          if [ -z "$JIRA_FILE" ]; then
            echo "‚ùå Jira report not found"
            exit 1
          fi
          echo "‚úÖ Jira: $JIRA_FILE"
          echo "jira_file=$JIRA_FILE" >> $GITHUB_OUTPUT

          # Check validation files
          if [ ! -f ".validation/output/result.json" ]; then
            echo "‚ùå Validation result.json not found"
            exit 1
          fi
          echo "‚úÖ Validation: .validation/output/result.json"

          # Check screenshots
          SCREENSHOT_COUNT=$(ls .validation/output/screenshots/*.png 2>/dev/null | wc -l | tr -d ' ')
          if [ "$SCREENSHOT_COUNT" -eq 0 ]; then
            echo "‚ùå No screenshots found"
            exit 1
          fi
          echo "‚úÖ Screenshots: $SCREENSHOT_COUNT files"
          echo "screenshot_count=$SCREENSHOT_COUNT" >> $GITHUB_OUTPUT

          # Check template
          if [ ! -f "clean-template-reorganized.html" ]; then
            echo "‚ùå Template not found"
            exit 1
          fi
          echo "‚úÖ Template: clean-template-reorganized.html"

          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT

      - name: Generate User Guide
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "üìù Generating user guide v$VERSION for: ${{ inputs.feature_slug }}"

          claude --print --model haiku "Using the comprehensive-user-guide-generator agent from the agents/ folder, generate the complete user guide for the ${{ inputs.feature_slug }} feature.

          Input files are in this repository:
          - Zendesk report: reports/zendesk/${{ inputs.feature_slug }}/versions/ (use latest)
          - Jira report: reports/jira/${{ inputs.feature_slug }}/versions/v1/runs/ (use latest)
          - Screenshots: .validation/output/screenshots/
          - Validation: .validation/output/result.json and pw_result.json
          - Template: clean-template-reorganized.html

          Output to: outputs/${{ inputs.feature_slug }}/user-guide_v${VERSION}.html
          Copy screenshots to: outputs/${{ inputs.feature_slug }}/screenshots/"

      - name: Commit and push user guide
        id: commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FEATURE_SLUG="${{ inputs.feature_slug }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add outputs/${FEATURE_SLUG}/ || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Generate user guide v${VERSION} for ${FEATURE_SLUG}

            ü§ñ Generated with Claude Code"
            git push
            echo "‚úÖ User guide committed and pushed"
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

          # Set output paths
          FILE_PATH="outputs/${FEATURE_SLUG}/user-guide_v${VERSION}.html"
          GITHUB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${FILE_PATH}"
          JIRA_GITHUB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${{ steps.verify.outputs.jira_file }}"
          ZENDESK_GITHUB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${{ steps.verify.outputs.zendesk_file }}"

          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          echo "github_url=$GITHUB_URL" >> $GITHUB_OUTPUT
          echo "jira_github_url=$JIRA_GITHUB_URL" >> $GITHUB_OUTPUT
          echo "zendesk_github_url=$ZENDESK_GITHUB_URL" >> $GITHUB_OUTPUT

      - name: Calculate generation duration
        id: duration
        run: |
          START_TIME="${{ steps.verify.outputs.start_time }}"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "‚è±Ô∏è Generation took ${DURATION} seconds"

      - name: Count validated claims
        id: claims
        run: |
          if [ -f ".validation/output/result.json" ]; then
            CLAIMS_COUNT=$(cat .validation/output/result.json | python3 -c "import sys, json; d=json.load(sys.stdin); print(len(d.get('validated_claims', [])))" 2>/dev/null || echo "0")
          else
            CLAIMS_COUNT=0
          fi
          echo "claims_count=$CLAIMS_COUNT" >> $GITHUB_OUTPUT
          echo "üìã Validated claims: $CLAIMS_COUNT"

      - name: Insert into Supabase
        if: steps.commit.outputs.committed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          curl -X POST "${{ env.SUPABASE_URL }}/rest/v1/user_guides" \
            -H "apikey: ${{ env.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{
              "feature_slug": "${{ inputs.feature_slug }}",
              "feature_name": "${{ inputs.feature_name }}",
              "version": '"$VERSION"',
              "file_path": "${{ steps.commit.outputs.file_path }}",
              "github_url": "${{ steps.commit.outputs.github_url }}",
              "jira_report_path": "${{ inputs.jira_report_path }}",
              "jira_report_github_url": "${{ steps.commit.outputs.jira_github_url }}",
              "zendesk_report_path": "${{ inputs.zendesk_report_path }}",
              "zendesk_report_github_url": "${{ steps.commit.outputs.zendesk_github_url }}",
              "validation_artifact_path": "${{ inputs.validation_artifact_path }}",
              "validation_artifact_url": "${{ inputs.validation_artifact_url }}",
              "screenshot_count": ${{ steps.verify.outputs.screenshot_count }},
              "validated_claims_count": ${{ steps.claims.outputs.claims_count }},
              "status": "generated",
              "generated_by": "claude-haiku",
              "generation_duration_seconds": ${{ steps.duration.outputs.duration }}
            }'

          echo "‚úÖ Inserted into Supabase"

      - name: Send Slack notification
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          STATUS="${{ job.status }}"

          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            COLOR="#36a64f"
            MESSAGE="User guide v${VERSION} generated successfully!"
          else
            EMOJI="‚ùå"
            COLOR="#ff0000"
            MESSAGE="User guide generation failed"
          fi

          curl -X POST "${{ env.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "'"$EMOJI"' User Guide Generation",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {"type": "mrkdwn", "text": "*Feature:*\n${{ inputs.feature_name }}"},
                      {"type": "mrkdwn", "text": "*Version:*\nv'"$VERSION"'"},
                      {"type": "mrkdwn", "text": "*Screenshots:*\n${{ steps.verify.outputs.screenshot_count }}"},
                      {"type": "mrkdwn", "text": "*Duration:*\n${{ steps.duration.outputs.duration }}s"}
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*GitHub URL:*\n<${{ steps.commit.outputs.github_url }}|View User Guide>"
                    }
                  }
                ]
              }]
            }' || echo "Slack notification failed (non-critical)"

      - name: Callback to n8n
        if: env.N8N_CALLBACK_URL != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          curl -X POST "${{ env.N8N_CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "${{ job.status }}",
              "feature_slug": "${{ inputs.feature_slug }}",
              "feature_name": "${{ inputs.feature_name }}",
              "version": '"$VERSION"',
              "file_path": "${{ steps.commit.outputs.file_path }}",
              "github_url": "${{ steps.commit.outputs.github_url }}",
              "screenshot_count": ${{ steps.verify.outputs.screenshot_count }},
              "validated_claims_count": ${{ steps.claims.outputs.claims_count }},
              "generation_duration_seconds": ${{ steps.duration.outputs.duration }}
            }' || echo "n8n callback failed (non-critical)"

      - name: Output result
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "üéâ User guide generation complete!"
          echo "üìÅ Output: outputs/${{ inputs.feature_slug }}/user-guide_v${VERSION}.html"
          echo "üîó GitHub URL: ${{ steps.commit.outputs.github_url }}"
          echo "üìä Screenshots: ${{ steps.verify.outputs.screenshot_count }}"
          echo "üìã Validated claims: ${{ steps.claims.outputs.claims_count }}"
          echo "‚è±Ô∏è Duration: ${{ steps.duration.outputs.duration }}s"
