name: Validate Feature Guide

on:
  push:
    paths:
      - '**/validation/request.json'
  workflow_dispatch:
    inputs:
      feature_folder:
        description: 'Feature folder to validate (e.g., daily-wage-calculator/v5)'
        required: true

jobs:
  validate:
    runs-on: [self-hosted, validation]
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect validation request
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.feature_folder }}" ]; then
            FOLDER="${{ github.event.inputs.feature_folder }}"
          else
            FOLDER=$(git diff --name-only HEAD~1 HEAD | grep 'validation/request.json' | head -1 | sed 's|/validation/request.json||')
          fi

          if [ -z "$FOLDER" ]; then
            echo "No validation request found"
            exit 0
          fi

          echo "folder=$FOLDER" >> $GITHUB_OUTPUT
          echo "request_file=$FOLDER/validation/request.json" >> $GITHUB_OUTPUT
          echo "result_file=$FOLDER/validation/result.json" >> $GITHUB_OUTPUT
          echo "Found validation request: $FOLDER"

      - name: Run Playwright MCP Validation
        if: steps.detect.outputs.folder != ''
        env:
          VALIDATION_REQUEST: ${{ steps.detect.outputs.request_file }}
          VALIDATION_RESULT: ${{ steps.detect.outputs.result_file }}
          FEATURE_FOLDER: ${{ steps.detect.outputs.folder }}
        run: |
          echo "Starting validation for: $FEATURE_FOLDER"
          echo "Request file: $VALIDATION_REQUEST"

          # Run Claude CLI with the validation request
          claude --print "
          You are a comprehensive UI validation agent. Read the validation request JSON at $GITHUB_WORKSPACE/$VALIDATION_REQUEST.

          IMPORTANT CONTEXT:
          - The nav.breadcrumb_array paths are HINTS only - they set context but may not be exact paths
          - Focus on the 'description', 'selector_hint', and 'assertion' fields to understand what to validate
          - Use your judgment to find the correct UI location if the suggested path doesn't match exactly

          FOR EACH PLAN:
          1. Navigate to app.bayzat.com
          2. Use the breadcrumb_array as a starting guide, but explore to find the correct feature
          3. Read the check's description and assertion carefully to understand the validation goal

          THOROUGH EXPLORATION REQUIRED:
          - Interact with EVERY UI element related to the feature: dropdowns, radio buttons, switches, toggles, accordions, links, tabs
          - Open dropdowns and document ALL available options
          - Click toggles/switches and observe state changes
          - Expand accordions to see hidden content
          - Follow relevant links to understand feature scope

          DOCUMENTATION REQUIREMENTS:
          For EVERY interaction, document:
          - What action was performed (clicked, selected, expanded, etc.)
          - What UI element was interacted with (exact text/label)
          - What happened after the interaction (success/failure/state change)
          - What options or content was revealed

          SCREENSHOT STRATEGY:
          - Take screenshots AFTER meaningful interactions, not just random captures
          - Name screenshots descriptively: {plan_id}_{check_id}_{action}.png
          - Save to $GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/screenshots/

          COMPREHENSIVE REPORT:
          Write a detailed validation report to $GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/report.md including:
          - Executive summary of validation results
          - For each plan: navigation path taken, all interactions performed, findings
          - List of all UI elements discovered and their states
          - What worked vs what didn't work
          - Any discrepancies between expected (assertion) and actual behavior

          RESULTS FILE:
          Write structured results to $GITHUB_WORKSPACE/$VALIDATION_RESULT following EXACTLY the output_schema.format in the request JSON.
          Include detailed 'notes' for each check explaining what was validated and how.

          Be thorough - we need a complete picture of the feature's UI state, not just pass/fail.
          " 2>&1 | tee "$GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/validation.log"

      - name: Commit Results
        if: steps.detect.outputs.folder != ''
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "${{ steps.detect.outputs.folder }}/validation/" || true
          git commit -m "validation: results for ${{ steps.detect.outputs.folder }}" || echo "No changes to commit"
          git push || echo "Push failed"

      - name: Notify n8n Complete
        if: always() && steps.detect.outputs.folder != ''
        run: |
          STATUS="${{ job.status }}"
          curl -s -X POST "https://automation-wh.bayzat.com/webhook/validation-complete" \
            -H "Content-Type: application/json" \
            -d "{
              \"feature_folder\": \"${{ steps.detect.outputs.folder }}\",
              \"status\": \"$STATUS\",
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }" || echo "Webhook failed (non-blocking)"
