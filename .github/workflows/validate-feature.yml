name: Validate Feature Guide

on:
  push:
    paths:
      - '**/validation/validation-payload.json'
  workflow_dispatch:
    inputs:
      feature_folder:
        description: 'Feature folder to validate (e.g., overtime/v1)'
        required: true
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'

env:
  PLAYWRIGHT_MCP_SERVER: "@executeautomation/playwright-mcp-server"
  NODE_VERSION: "20"

jobs:
  validate:
    runs-on: [self-hosted, validation]
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          persist-credentials: false

      - name: Detect validation payload
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.feature_folder }}" ]; then
            FOLDER="${{ github.event.inputs.feature_folder }}"
          else
            CHANGED_FILE=$(git diff --name-only HEAD~1 HEAD | grep 'validation/validation-payload.json' | head -1)
            if [ -n "$CHANGED_FILE" ]; then
              FOLDER=$(echo "$CHANGED_FILE" | sed 's|/validation/.*||')
            fi
          fi

          if [ -z "$FOLDER" ]; then
            echo "No validation request found"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PAYLOAD_FILE="$GITHUB_WORKSPACE/$FOLDER/validation/validation-payload.json"
          if [ ! -f "$PAYLOAD_FILE" ]; then
            echo "Payload file not found: $PAYLOAD_FILE"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "folder=$FOLDER" >> $GITHUB_OUTPUT
          echo "payload_file=$PAYLOAD_FILE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

          # Extract feature info (supports object format with .feature_info)
          FEATURE_NAME=$(jq -r '.feature_info.feature_name // .metadata.feature_name // "unknown"' "$PAYLOAD_FILE")
          FEATURE_SLUG=$(jq -r '.feature_info.feature_slug // .metadata.feature_slug // "unknown"' "$PAYLOAD_FILE")
          VERSION=$(jq -r '.feature_info.next_version // .metadata.version // "v1"' "$PAYLOAD_FILE")

          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          echo "feature_slug=$FEATURE_SLUG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup directories
        id: dirs
        if: steps.detect.outputs.skip != 'true'
        run: |
          FOLDER="${{ steps.detect.outputs.folder }}"
          BASE_DIR="$GITHUB_WORKSPACE/$FOLDER/validation"

          # Create all output directories
          mkdir -p "$BASE_DIR/screenshots"
          mkdir -p "$BASE_DIR/results"
          mkdir -p "$BASE_DIR/logs"
          mkdir -p "$BASE_DIR/artifacts"

          # Output paths for later steps
          echo "base_dir=$BASE_DIR" >> $GITHUB_OUTPUT
          echo "screenshots_dir=$BASE_DIR/screenshots" >> $GITHUB_OUTPUT
          echo "results_dir=$BASE_DIR/results" >> $GITHUB_OUTPUT
          echo "logs_dir=$BASE_DIR/logs" >> $GITHUB_OUTPUT
          echo "result_file=$BASE_DIR/result.json" >> $GITHUB_OUTPUT
          echo "report_file=$BASE_DIR/report.md" >> $GITHUB_OUTPUT
          echo "log_file=$BASE_DIR/logs/validation.log" >> $GITHUB_OUTPUT

          echo "Output directories created:"
          echo "  Screenshots: $BASE_DIR/screenshots"
          echo "  Results: $BASE_DIR/results"
          echo "  Logs: $BASE_DIR/logs"
          echo "  Artifacts: $BASE_DIR/artifacts"

      - name: Setup Node.js
        if: steps.detect.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright MCP
        if: steps.detect.outputs.skip != 'true'
        run: npm install -g ${{ env.PLAYWRIGHT_MCP_SERVER }}

      - name: Run Playwright Validation
        if: steps.detect.outputs.skip != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          APP_USERNAME: ${{ secrets.APP_USERNAME }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          FOLDER="${{ steps.detect.outputs.folder }}"
          PAYLOAD_FILE="${{ steps.detect.outputs.payload_file }}"
          FEATURE_NAME="${{ steps.detect.outputs.feature_name }}"
          SCREENSHOTS_DIR="${{ steps.dirs.outputs.screenshots_dir }}"
          RESULT_FILE="${{ steps.dirs.outputs.result_file }}"
          LOG_FILE="${{ steps.dirs.outputs.log_file }}"

          # Create the prompt file
          PROMPT_FILE=$(mktemp)
          cat > "$PROMPT_FILE" << 'PROMPT_HEADER'
          You are a QA validation agent using Playwright MCP to explore and validate a feature in the Bayzat HR application.

          ## YOUR MISSION
          Freely explore the feature described in the payload below. Your goal is to:
          1. Successfully log in to the application
          2. Navigate to the feature location
          3. Explore each task/workflow described
          4. Take screenshots as evidence
          5. Document what works and what doesn't

          ## CRITICAL FIRST STEPS

          ### Step 1: Browser Setup
          FIRST, call browser_resize with width=1920, height=1200

          ### Step 2: Login
          1. Navigate to the base URL (login page)
          2. Take a snapshot to see the login form
          3. Fill in the email field with the username
          4. Fill in the password field with the password
          5. Click the login/submit button
          6. Wait 3 seconds for the page to load
          7. Take a screenshot to confirm login success

          ### Step 3: Dismiss any tooltips/onboarding
          After login, run this JavaScript to remove tooltips:
          ```javascript
          () => {
            const selectors = ['[class*="tour"]', '[class*="tooltip"]', '[class*="onboarding"]',
                              '[class*="shepherd"]', '[role="dialog"]', '[aria-modal="true"]'];
            selectors.forEach(sel => {
              document.querySelectorAll(sel).forEach(el => {
                if (el.textContent.includes('Step') || el.textContent.includes('Next') ||
                    el.textContent.includes('Skip')) {
                  el.remove();
                }
              });
            });
            document.querySelectorAll('[class*="backdrop"], [class*="overlay"]').forEach(el => el.remove());
            return 'Tooltips removed';
          }
          ```

          ### Step 4: Explore the Feature
          Based on the payload's "where_to_go" and "what_to_do" sections:
          1. Navigate to the feature location
          2. For each task in "what_to_do", try to follow the steps
          3. Take screenshots at key points
          4. Note any issues or blockers you encounter

          ### Step 5: DEEP UI EXPLORATION (CRITICAL)
          Thoroughly explore ALL areas of the UI related to this feature:

          1. **Navigate every tab, section, and sub-menu** related to the feature
          2. **Click on every button, link, and interactive element** to see what happens
          3. **Open all dropdowns, modals, and expandable sections**
          4. **Test form fields** - what options are available, what validations exist

          **Document these UI behaviors:**
          - **Disabled states**: Which buttons/fields are disabled and under what conditions?
          - **Conditional logic**: What appears/disappears based on selections?
          - **Progressive disclosure**: What new options appear after certain actions?
          - **Required vs optional fields**: Which fields must be filled?
          - **Validation messages**: What errors appear for invalid input?
          - **Default values**: What pre-filled values exist?
          - **Tooltips and help text**: What guidance does the UI provide?
          - **Loading states**: How does the UI indicate processing?
          - **Success/error feedback**: What confirmations appear after actions?
          - **Permission-based visibility**: Are any elements hidden/shown based on role?

          Take screenshots of each distinct UI state you discover.

          ## OUTPUT FORMAT
          At the end, create a JSON result with this structure:
          {
            "validation_status": "completed" or "partial" or "blocked",
            "login_success": true/false,
            "feature_accessible": true/false,
            "tasks_explored": [
              {
                "task": "task name",
                "status": "completed" or "partial" or "blocked",
                "notes": "what you observed",
                "screenshots": ["screenshot1.png"]
              }
            ],
            "ui_behaviors_documented": {
              "disabled_states": [
                {"element": "element name", "condition": "when/why it's disabled"}
              ],
              "conditional_logic": [
                {"trigger": "what action", "result": "what appears/changes"}
              ],
              "progressive_disclosure": [
                {"action": "user action", "reveals": "what new content appears"}
              ],
              "required_fields": ["list of required fields"],
              "optional_fields": ["list of optional fields"],
              "default_values": [
                {"field": "field name", "default": "default value"}
              ],
              "validation_rules": [
                {"field": "field name", "rule": "validation rule", "error_message": "message shown"}
              ],
              "tooltips_help_text": [
                {"element": "element name", "text": "tooltip/help content"}
              ]
            },
            "ui_sections_explored": ["list of all sections/tabs/pages visited"],
            "issues_found": ["list of any issues"],
            "summary": "brief summary of exploration"
          }

          PROMPT_HEADER

          cat >> "$PROMPT_FILE" << EOF

          ## CREDENTIALS
          - Base URL: $APP_BASE_URL
          - Username: $APP_USERNAME
          - Password: $APP_PASSWORD

          ## SCREENSHOTS DIRECTORY
          Save all screenshots to: $SCREENSHOTS_DIR

          ## FEATURE PAYLOAD
          $(cat "$PAYLOAD_FILE")

          ## BEGIN EXPLORATION
          Start by setting up the browser, then login, then explore the feature freely.
          Take your time and document everything you find.
          EOF

          echo "Starting Playwright validation for: $FEATURE_NAME"
          echo "============================================"

          # Run Claude Code with Playwright MCP (using Chromium for reliability)
          npx @anthropic-ai/claude-code@latest \
            --print \
            --max-turns 100 \
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@executeautomation/playwright-mcp-server","--browser","chromium"]}}}' \
            --prompt-file "$PROMPT_FILE" \
            --output-format json > "$RESULT_FILE.raw" 2>&1 || true

          # Extract just the JSON result if possible
          if [ -f "$RESULT_FILE.raw" ]; then
            # Try to extract JSON from the output
            grep -o '{.*}' "$RESULT_FILE.raw" | tail -1 > "$RESULT_FILE" 2>/dev/null || cp "$RESULT_FILE.raw" "$RESULT_FILE"
          fi

          echo "============================================"
          echo "Validation complete"

      - name: Generate Report
        if: steps.detect.outputs.skip != 'true'
        run: |
          FOLDER="${{ steps.detect.outputs.folder }}"
          FEATURE_NAME="${{ steps.detect.outputs.feature_name }}"
          RESULT_FILE="${{ steps.dirs.outputs.result_file }}"
          REPORT_FILE="${{ steps.dirs.outputs.report_file }}"
          SCREENSHOTS_DIR="${{ steps.dirs.outputs.screenshots_dir }}"

          cat > "$REPORT_FILE" << EOF
          # Validation Report: $FEATURE_NAME

          **Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Run ID**: ${{ github.run_id }}

          ## Result
          \`\`\`json
          $(cat "$RESULT_FILE" 2>/dev/null || echo '{"error": "No result file generated"}')
          \`\`\`

          ## Screenshots
          $(ls -la "$SCREENSHOTS_DIR/" 2>/dev/null || echo "No screenshots found")
          EOF

          echo "Report generated: $REPORT_FILE"

      - name: Commit Results
        if: steps.detect.outputs.skip != 'true'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          FOLDER="${{ steps.detect.outputs.folder }}"
          FEATURE_NAME="${{ steps.detect.outputs.feature_name }}"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote set-url origin "https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}"

          git add "$FOLDER/validation/" || true
          git commit -m "validation: $FEATURE_NAME exploration results" || echo "No changes to commit"
          git push || echo "Push failed"

      - name: Notify n8n
        if: always() && steps.detect.outputs.skip != 'true'
        run: |
          curl -s -X POST "https://automation-wh.bayzat.com/webhook/validation-complete" \
            -H "Content-Type: application/json" \
            -d '{
              "feature_folder": "${{ steps.detect.outputs.folder }}",
              "feature_name": "${{ steps.detect.outputs.feature_name }}",
              "status": "${{ job.status }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "Webhook notification failed (non-blocking)"
