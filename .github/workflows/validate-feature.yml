name: Validate Feature Guide

on:
  push:
    paths:
      - '**/validation/request.json'
  workflow_dispatch:
    inputs:
      feature_folder:
        description: 'Feature folder to validate (e.g., daily-wage-calculator/v5)'
        required: true

jobs:
  validate:
    runs-on: [self-hosted, validation]
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect validation request
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.feature_folder }}" ]; then
            FOLDER="${{ github.event.inputs.feature_folder }}"
          else
            FOLDER=$(git diff --name-only HEAD~1 HEAD | grep 'validation/request.json' | head -1 | sed 's|/validation/request.json||')
          fi

          if [ -z "$FOLDER" ]; then
            echo "No validation request found"
            exit 0
          fi

          echo "folder=$FOLDER" >> $GITHUB_OUTPUT
          echo "request_file=$FOLDER/validation/request.json" >> $GITHUB_OUTPUT
          echo "result_file=$FOLDER/validation/result.json" >> $GITHUB_OUTPUT
          echo "screenshots_dir=$FOLDER/validation/screenshots" >> $GITHUB_OUTPUT
          echo "Found validation request: $FOLDER"

      - name: Prepare Screenshots Directory
        if: steps.detect.outputs.folder != ''
        run: |
          mkdir -p "$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}"

      - name: Install Claude CLI
        if: steps.detect.outputs.folder != ''
        run: |
          echo "Installing Claude CLI..."
          npm install -g @anthropic-ai/claude-code
          # Add npm global bin to PATH
          export PATH="$(npm prefix -g)/bin:$PATH"
          echo "PATH=$PATH"
          which claude
          claude --version
          echo "✅ Claude CLI installed"

      - name: Install Playwright MCP and Browsers
        if: steps.detect.outputs.folder != ''
        run: |
          echo "Pre-installing Playwright MCP package..."
          npm install -g @playwright/mcp 2>/dev/null || npx -y @playwright/mcp --version
          echo "Installing Playwright browsers..."
          npx -y playwright install chromium
          echo "✅ Playwright MCP and browsers ready"

      - name: Setup MCP Configuration
        if: steps.detect.outputs.folder != ''
        run: |
          echo "Setting up MCP configuration..."
          # Remove any existing config and create fresh
          rm -f "$GITHUB_WORKSPACE/.mcp.json"
          # Headed mode: browser window visible for live monitoring on self-hosted runner
          echo '{"mcpServers":{"playwright":{"command":"npx","args":["-y","@playwright/mcp"]}}}' > "$GITHUB_WORKSPACE/.mcp.json"
          echo "MCP config created at: $GITHUB_WORKSPACE/.mcp.json"
          cat "$GITHUB_WORKSPACE/.mcp.json"

      - name: Run Playwright MCP Validation
        if: steps.detect.outputs.folder != ''
        env:
          VALIDATION_REQUEST: ${{ steps.detect.outputs.request_file }}
          VALIDATION_RESULT: ${{ steps.detect.outputs.result_file }}
          FEATURE_FOLDER: ${{ steps.detect.outputs.folder }}
          SCREENSHOTS_DIR: ${{ steps.detect.outputs.screenshots_dir }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          APP_USERNAME: ${{ secrets.APP_USERNAME }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Starting validation for: $FEATURE_FOLDER"
          echo "Request file: $VALIDATION_REQUEST"
          echo "Screenshots directory: $SCREENSHOTS_DIR"
          echo "Target URL: $APP_BASE_URL"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Current directory: $(pwd)"
          echo "MCP config location: $GITHUB_WORKSPACE/.mcp.json"
          ls -la "$GITHUB_WORKSPACE/.mcp.json" || echo "MCP config not found!"

          # Change to workspace directory to ensure MCP loads correctly
          cd "$GITHUB_WORKSPACE"

          # Add npm global bin to PATH
          export PATH="$(npm prefix -g)/bin:$PATH"

          # Run Claude CLI with timeout (15 min max) and cleanup on exit
          # Using timeout to prevent indefinite hangs when MCP browser doesn't close
          timeout 900 claude --allowedTools "mcp__playwright__*,Read,Write,Glob,Grep" --mcp-config ".mcp.json" --print "
          You are a comprehensive UI validation agent. Read the validation request JSON at $GITHUB_WORKSPACE/$VALIDATION_REQUEST.

          AUTHENTICATION:
          - Navigate to: $APP_BASE_URL
          - Username: $APP_USERNAME
          - Password: $APP_PASSWORD
          - Complete login before proceeding with validation

          POST-LOGIN ONBOARDING DISMISSAL (CRITICAL):
          - After successful login, an onboarding overlay may appear showing 'Step 1 of 4' or similar
          - This modal blocks the main UI and MUST be dismissed before any navigation
          - Look for an X button (close icon) in the top-right corner of the onboarding popup
          - Click the X to dismiss the onboarding modal completely
          - Wait for the overlay to close and the main dashboard to be fully visible
          - Take a screenshot AFTER dismissing onboarding (step-02-onboarding-dismissed.png)
          - Only proceed with feature navigation once the dashboard is clear of overlays

          IMPORTANT CONTEXT:
          - The nav.breadcrumb_array paths are HINTS only - they set context but may not be exact paths
          - Focus on the 'description', 'selector_hint', and 'assertion' fields to understand what to validate
          - Use your judgment to find the correct UI location if the suggested path doesn't match exactly

          FOR EACH PLAN:
          1. Navigate to app.bayzat.com
          2. Use the breadcrumb_array as a starting guide, but explore to find the correct feature
          3. Read the check's description and assertion carefully to understand the validation goal

          THOROUGH EXPLORATION REQUIRED:
          - Interact with EVERY UI element related to the feature: dropdowns, radio buttons, switches, toggles, accordions, links, tabs
          - Open dropdowns and document ALL available options
          - Click toggles/switches and observe state changes
          - Expand accordions to see hidden content
          - Follow relevant links to understand feature scope

          DOCUMENTATION REQUIREMENTS:
          For EVERY interaction, document:
          - What action was performed (clicked, selected, expanded, etc.)
          - What UI element was interacted with (exact text/label)
          - What happened after the interaction (success/failure/state change)
          - What options or content was revealed

          ============================================================
          SCREENSHOT SPECIFICATIONS (MANDATORY)
          ============================================================

          SCREENSHOT PHILOSOPHY:
          - SMART SCREENSHOTS: Focused captures only, NO full page screenshots
          - Capture specific UI elements, not entire browser windows
          - Every screenshot must serve a validation purpose

          CONTEXTUAL NAMING CONVENTION (MANDATORY):
          All screenshots saved to: $GITHUB_WORKSPACE/$SCREENSHOTS_DIR/

          NAMING PHILOSOPHY:
          Screenshot names MUST describe the SCREEN/FEATURE being captured, NOT generic claim numbers.
          Names should be self-documenting - anyone reading the filename should understand what it shows.

          Required Baseline Screenshots:
          - 00-login-page.png                    (login screen before authentication)
          - 01-dashboard-after-login.png         (main dashboard after successful login)
          - 02-onboarding-dismissed.png          (dashboard after closing onboarding modal)
          - final-validation-complete.png        (end state after all validations)

          Navigation Screenshots (describe the destination):
          - nav-settings-menu.png                (settings menu opened)
          - nav-payroll-section.png              (payroll settings section)
          - nav-leaves-section.png               (leaves settings section)
          - nav-[section]-[subsection].png       (pattern: nav-payroll-daily-wage.png)

          Feature Validation Screenshots (describe the feature/screen):
          - daily-wage-calculation-config.png         (daily wage calculation configuration screen)
          - daily-wage-calculation-options.png        (showing available calculation options)
          - eos-eligibility-settings.png              (end of service eligibility settings)
          - eos-salary-components-dropdown.png        (salary components dropdown expanded)
          - leave-policy-unpaid-config.png            (unpaid leave policy configuration)
          - leave-policy-deduction-formula.png        (deduction formula display)
          - proration-settings-calendar-days.png      (proration with calendar days selected)
          - proration-settings-working-days.png       (proration with working days selected)
          - proration-settings-custom-days.png        (proration with custom days selected)

          UI State Screenshots (describe what state is being shown):
          - dropdown-calculation-basis-expanded.png   (dropdown showing all options)
          - radio-salary-components-basic-selected.png
          - toggle-override-enabled.png
          - warning-payroll-month-impact.png
          - error-validation-failed.png

          Evidence Screenshots (describe the evidence):
          - evidence-formula-display.png
          - evidence-override-indicator-visible.png
          - evidence-greyed-out-field.png

          NAMING RULES (STRICT):
          - Format: .png ONLY (no .jpg, .jpeg, .webp)
          - Pattern: [context]-[feature]-[detail].png
          - Slugs: kebab-case only (lowercase, hyphens)
          - Characters: ASCII only (no unicode, no spaces)
          - Length: Max 50 characters total
          - MUST be descriptive of screen content, NOT generic numbers

          SCREENSHOT MANIFEST:
          After all screenshots, create manifest at:
          $GITHUB_WORKSPACE/$SCREENSHOTS_DIR/manifest.json

          Manifest format:
          {
            \"generated_at\": \"ISO-8601 timestamp\",
            \"total_screenshots\": N,
            \"screenshots\": [
              {
                \"filename\": \"step-00-start.png\",
                \"category\": \"baseline\",
                \"description\": \"Initial dashboard state\",
                \"timestamp\": \"ISO-8601\"
              }
            ]
          }

          ============================================================

          COMPREHENSIVE REPORT:
          Write a detailed validation report to $GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/report.md including:
          - Executive summary of validation results
          - For each plan: navigation path taken, all interactions performed, findings
          - List of all UI elements discovered and their states
          - What worked vs what didn't work
          - Any discrepancies between expected (assertion) and actual behavior
          - Screenshot inventory with descriptions

          RESULTS FILE:
          Write structured results to $GITHUB_WORKSPACE/$VALIDATION_RESULT following EXACTLY the output_schema.format in the request JSON.
          Include detailed 'notes' for each check explaining what was validated and how.
          Include 'screenshots' array referencing captured evidence.

          Be thorough - we need a complete picture of the feature's UI state, not just pass/fail.
          " 2>&1 | tee "$GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/validation.log"

          # Cleanup: Kill any orphaned browser/MCP processes
          pkill -f "mcp-server-playwright" 2>/dev/null || true
          pkill -f "chrome.*playwright" 2>/dev/null || true
          echo "✅ Cleanup complete"

      - name: Validate Screenshot Manifest
        if: steps.detect.outputs.folder != ''
        run: |
          MANIFEST="$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}/manifest.json"
          if [ -f "$MANIFEST" ]; then
            echo "Screenshot manifest found:"
            cat "$MANIFEST" | jq '.total_screenshots, .screenshots | length'
          else
            echo "Warning: No screenshot manifest generated"
          fi

      - name: Commit Results
        if: steps.detect.outputs.folder != ''
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "${{ steps.detect.outputs.folder }}/validation/" || true
          git commit -m "validation: results for ${{ steps.detect.outputs.folder }}" || echo "No changes to commit"
          git push || echo "Push failed"

      - name: Notify n8n Complete
        if: always() && steps.detect.outputs.folder != ''
        run: |
          STATUS="${{ job.status }}"
          SCREENSHOT_COUNT=$(cat "$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}/manifest.json" 2>/dev/null | jq '.total_screenshots // 0' || echo "0")
          curl -s -X POST "https://automation-wh.bayzat.com/webhook/validation-complete" \
            -H "Content-Type: application/json" \
            -d "{
              \"feature_folder\": \"${{ steps.detect.outputs.folder }}\",
              \"status\": \"$STATUS\",
              \"screenshot_count\": $SCREENSHOT_COUNT,
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }" || echo "Webhook failed (non-blocking)"

      - name: Notify Slack
        if: always() && steps.detect.outputs.folder != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            exit 0
          fi

          STATUS="${{ job.status }}"
          FOLDER="${{ steps.detect.outputs.folder }}"
          SCREENSHOT_COUNT=$(cat "$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}/manifest.json" 2>/dev/null | jq '.total_screenshots // 0' || echo "0")

          # Extract feature name and version from folder path
          FEATURE_NAME=$(echo "$FOLDER" | cut -d'/' -f1)
          VERSION=$(echo "$FOLDER" | cut -d'/' -f2)

          # Set emoji based on status
          if [ "$STATUS" = "success" ]; then
            EMOJI=":white_check_mark:"
            COLOR="good"
          else
            EMOJI=":x:"
            COLOR="danger"
          fi

          # Build GitHub links
          REPO_URL="https://github.com/${{ github.repository }}"
          VALIDATION_URL="$REPO_URL/tree/main/$FOLDER/validation"
          RUN_URL="$REPO_URL/actions/runs/${{ github.run_id }}"

          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"$EMOJI Feature Validation Complete\",
                      \"emoji\": true
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {\"type\": \"mrkdwn\", \"text\": \"*Feature:*\n$FEATURE_NAME\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Version:*\n$VERSION\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Status:*\n$STATUS\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Screenshots:*\n$SCREENSHOT_COUNT\"}
                    ]
                  },
                  {
                    \"type\": \"actions\",
                    \"elements\": [
                      {
                        \"type\": \"button\",
                        \"text\": {\"type\": \"plain_text\", \"text\": \"View Results\"},
                        \"url\": \"$VALIDATION_URL\"
                      },
                      {
                        \"type\": \"button\",
                        \"text\": {\"type\": \"plain_text\", \"text\": \"View Run\"},
                        \"url\": \"$RUN_URL\"
                      }
                    ]
                  }
                ]
              }]
            }" || echo "Slack notification failed (non-blocking)"
