name: Validate Feature Guide

on:
  push:
    paths:
      - '**/validation/request.json'
  workflow_dispatch:
    inputs:
      feature_folder:
        description: 'Feature folder to validate (e.g., daily-wage-calculator/v5)'
        required: true

jobs:
  validate:
    runs-on: [self-hosted, validation]
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect validation request
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.feature_folder }}" ]; then
            FOLDER="${{ github.event.inputs.feature_folder }}"
          else
            FOLDER=$(git diff --name-only HEAD~1 HEAD | grep 'validation/request.json' | head -1 | sed 's|/validation/request.json||')
          fi

          if [ -z "$FOLDER" ]; then
            echo "No validation request found"
            exit 0
          fi

          echo "folder=$FOLDER" >> $GITHUB_OUTPUT
          echo "request_file=$FOLDER/validation/request.json" >> $GITHUB_OUTPUT
          echo "result_file=$FOLDER/validation/result.json" >> $GITHUB_OUTPUT
          echo "screenshots_dir=$FOLDER/validation/screenshots" >> $GITHUB_OUTPUT
          echo "Found validation request: $FOLDER"

      - name: Prepare Screenshots Directory
        if: steps.detect.outputs.folder != ''
        run: |
          mkdir -p "$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}"

      - name: Run Playwright MCP Validation
        if: steps.detect.outputs.folder != ''
        env:
          VALIDATION_REQUEST: ${{ steps.detect.outputs.request_file }}
          VALIDATION_RESULT: ${{ steps.detect.outputs.result_file }}
          FEATURE_FOLDER: ${{ steps.detect.outputs.folder }}
          SCREENSHOTS_DIR: ${{ steps.detect.outputs.screenshots_dir }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          APP_USERNAME: ${{ secrets.APP_USERNAME }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Starting validation for: $FEATURE_FOLDER"
          echo "Request file: $VALIDATION_REQUEST"
          echo "Screenshots directory: $SCREENSHOTS_DIR"
          echo "Target URL: $APP_BASE_URL"

          # Run Claude CLI with the validation request (skip permissions for CI)
          claude --dangerously-skip-permissions --mcp-config "$GITHUB_WORKSPACE/.mcp.json" --print "
          You are a comprehensive UI validation agent. Read the validation request JSON at $GITHUB_WORKSPACE/$VALIDATION_REQUEST.

          AUTHENTICATION:
          - Navigate to: $APP_BASE_URL
          - Username: $APP_USERNAME
          - Password: $APP_PASSWORD
          - Complete login before proceeding with validation

          IMPORTANT CONTEXT:
          - The nav.breadcrumb_array paths are HINTS only - they set context but may not be exact paths
          - Focus on the 'description', 'selector_hint', and 'assertion' fields to understand what to validate
          - Use your judgment to find the correct UI location if the suggested path doesn't match exactly

          FOR EACH PLAN:
          1. Navigate to app.bayzat.com
          2. Use the breadcrumb_array as a starting guide, but explore to find the correct feature
          3. Read the check's description and assertion carefully to understand the validation goal

          THOROUGH EXPLORATION REQUIRED:
          - Interact with EVERY UI element related to the feature: dropdowns, radio buttons, switches, toggles, accordions, links, tabs
          - Open dropdowns and document ALL available options
          - Click toggles/switches and observe state changes
          - Expand accordions to see hidden content
          - Follow relevant links to understand feature scope

          DOCUMENTATION REQUIREMENTS:
          For EVERY interaction, document:
          - What action was performed (clicked, selected, expanded, etc.)
          - What UI element was interacted with (exact text/label)
          - What happened after the interaction (success/failure/state change)
          - What options or content was revealed

          ============================================================
          SCREENSHOT SPECIFICATIONS (MANDATORY)
          ============================================================

          SCREENSHOT PHILOSOPHY:
          - SMART SCREENSHOTS: Focused captures only, NO full page screenshots
          - Capture specific UI elements, not entire browser windows
          - Every screenshot must serve a validation purpose

          DETERMINISTIC NAMING CONVENTION:
          All screenshots saved to: $GITHUB_WORKSPACE/$SCREENSHOTS_DIR/

          Required Baseline Screenshots:
          - step-00-start.png      (initial state before any action)
          - step-01-login.png      (after authentication)
          - final-state.png        (end state after all validations)

          Navigation Path Screenshots:
          - path-01.png            (first navigation step)
          - path-02.png            (second navigation step)
          - path-NN.png            (continue with zero-padded numbers)

          Claim Validation Screenshots (one per claim):
          - claim-01-pass.png           (claim validated successfully)
          - claim-01-fail.png           (claim failed validation)
          - claim-01-not-confirmed.png  (claim could not be verified)
          - claim-02-pass.png           (next claim, etc.)

          Evidence Screenshots (optional, for additional proof):
          - claim-01-evidence-01.png    (supporting evidence for claim 01)
          - claim-01-evidence-02.png    (additional evidence if needed)

          Extra Captures (for unexpected findings):
          - extra-01-dropdown-options.png
          - extra-02-error-message.png
          - extra-NN-<short-slug>.png

          NAMING RULES (STRICT):
          - Format: .png ONLY (no .jpg, .jpeg, .webp)
          - Numbers: Zero-padded (01, 02, ... 99)
          - Slugs: kebab-case only (lowercase, hyphens)
          - Characters: ASCII only (no unicode, no spaces)
          - Length: Slug portion max 30 characters

          SCREENSHOT MANIFEST:
          After all screenshots, create manifest at:
          $GITHUB_WORKSPACE/$SCREENSHOTS_DIR/manifest.json

          Manifest format:
          {
            \"generated_at\": \"ISO-8601 timestamp\",
            \"total_screenshots\": N,
            \"screenshots\": [
              {
                \"filename\": \"step-00-start.png\",
                \"category\": \"baseline\",
                \"description\": \"Initial dashboard state\",
                \"timestamp\": \"ISO-8601\"
              }
            ]
          }

          ============================================================

          COMPREHENSIVE REPORT:
          Write a detailed validation report to $GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/report.md including:
          - Executive summary of validation results
          - For each plan: navigation path taken, all interactions performed, findings
          - List of all UI elements discovered and their states
          - What worked vs what didn't work
          - Any discrepancies between expected (assertion) and actual behavior
          - Screenshot inventory with descriptions

          RESULTS FILE:
          Write structured results to $GITHUB_WORKSPACE/$VALIDATION_RESULT following EXACTLY the output_schema.format in the request JSON.
          Include detailed 'notes' for each check explaining what was validated and how.
          Include 'screenshots' array referencing captured evidence.

          Be thorough - we need a complete picture of the feature's UI state, not just pass/fail.
          " 2>&1 | tee "$GITHUB_WORKSPACE/$FEATURE_FOLDER/validation/validation.log"

      - name: Validate Screenshot Manifest
        if: steps.detect.outputs.folder != ''
        run: |
          MANIFEST="$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}/manifest.json"
          if [ -f "$MANIFEST" ]; then
            echo "Screenshot manifest found:"
            cat "$MANIFEST" | jq '.total_screenshots, .screenshots | length'
          else
            echo "Warning: No screenshot manifest generated"
          fi

      - name: Commit Results
        if: steps.detect.outputs.folder != ''
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "${{ steps.detect.outputs.folder }}/validation/" || true
          git commit -m "validation: results for ${{ steps.detect.outputs.folder }}" || echo "No changes to commit"
          git push || echo "Push failed"

      - name: Notify n8n Complete
        if: always() && steps.detect.outputs.folder != ''
        run: |
          STATUS="${{ job.status }}"
          SCREENSHOT_COUNT=$(cat "$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}/manifest.json" 2>/dev/null | jq '.total_screenshots // 0' || echo "0")
          curl -s -X POST "https://automation-wh.bayzat.com/webhook/validation-complete" \
            -H "Content-Type: application/json" \
            -d "{
              \"feature_folder\": \"${{ steps.detect.outputs.folder }}\",
              \"status\": \"$STATUS\",
              \"screenshot_count\": $SCREENSHOT_COUNT,
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }" || echo "Webhook failed (non-blocking)"

      - name: Notify Slack
        if: always() && steps.detect.outputs.folder != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification"
            exit 0
          fi

          STATUS="${{ job.status }}"
          FOLDER="${{ steps.detect.outputs.folder }}"
          SCREENSHOT_COUNT=$(cat "$GITHUB_WORKSPACE/${{ steps.detect.outputs.screenshots_dir }}/manifest.json" 2>/dev/null | jq '.total_screenshots // 0' || echo "0")

          # Extract feature name and version from folder path
          FEATURE_NAME=$(echo "$FOLDER" | cut -d'/' -f1)
          VERSION=$(echo "$FOLDER" | cut -d'/' -f2)

          # Set emoji based on status
          if [ "$STATUS" = "success" ]; then
            EMOJI=":white_check_mark:"
            COLOR="good"
          else
            EMOJI=":x:"
            COLOR="danger"
          fi

          # Build GitHub links
          REPO_URL="https://github.com/${{ github.repository }}"
          VALIDATION_URL="$REPO_URL/tree/main/$FOLDER/validation"
          RUN_URL="$REPO_URL/actions/runs/${{ github.run_id }}"

          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"$EMOJI Feature Validation Complete\",
                      \"emoji\": true
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {\"type\": \"mrkdwn\", \"text\": \"*Feature:*\n$FEATURE_NAME\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Version:*\n$VERSION\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Status:*\n$STATUS\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Screenshots:*\n$SCREENSHOT_COUNT\"}
                    ]
                  },
                  {
                    \"type\": \"actions\",
                    \"elements\": [
                      {
                        \"type\": \"button\",
                        \"text\": {\"type\": \"plain_text\", \"text\": \"View Results\"},
                        \"url\": \"$VALIDATION_URL\"
                      },
                      {
                        \"type\": \"button\",
                        \"text\": {\"type\": \"plain_text\", \"text\": \"View Run\"},
                        \"url\": \"$RUN_URL\"
                      }
                    ]
                  }
                ]
              }]
            }" || echo "Slack notification failed (non-blocking)"
