name: Interface Validation (Playwright + Claude)

on:
  workflow_dispatch:
    inputs:
      feature_name:
        description: "Feature name to validate (e.g., daily_wage_calculator)"
        required: true
        type: string
      claims_json:
        description: "Claims to validate (JSON string). Example: [\"claim 1\",\"claim 2\"]"
        required: true
        type: string
      navigation_paths_json:
        description: "Navigation paths (JSON string). Example: [\"Settings > Payroll\"]"
        required: false
        default: "[]"
        type: string

jobs:
  validate-interface:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Build a run-scoped evidence folder so every run is unique and never overwrites
      - name: Compute evidence paths
        shell: bash
        run: |
          set -euo pipefail

          FEATURE="${{ github.event.inputs.feature_name }}"
          RUN_ID="${{ github.run_id }}"

          EVID_DIR="evidence/${FEATURE}/${RUN_ID}"
          SHOTS_DIR="${EVID_DIR}/screenshots"
          REPORTS_DIR="${EVID_DIR}/reports"

          echo "EVID_DIR=${EVID_DIR}" >> $GITHUB_ENV
          echo "SHOTS_DIR=${SHOTS_DIR}" >> $GITHUB_ENV
          echo "REPORTS_DIR=${REPORTS_DIR}" >> $GITHUB_ENV
          echo "EVIDENCE_FILE=${REPORTS_DIR}/evidence.json" >> $GITHUB_ENV
          echo "SUMMARY_FILE=${REPORTS_DIR}/summary.md" >> $GITHUB_ENV

          mkdir -p "${SHOTS_DIR}" "${REPORTS_DIR}"

      - name: Write validation input (with output_configuration)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p .validation/input

          cat > .validation/input/request.json <<EOF
          {
            "feature_name": "${{ github.event.inputs.feature_name }}",
            "claims_to_validate": ${{ github.event.inputs.claims_json }},
            "navigation_paths": ${{ github.event.inputs.navigation_paths_json }},
            "output_configuration": {
              "screenshots_dir": "${{ env.SHOTS_DIR }}",
              "reports_dir": "${{ env.REPORTS_DIR }}",
              "evidence_file": "${{ env.EVIDENCE_FILE }}",
              "summary_file": "${{ env.SUMMARY_FILE }}"
            }
          }
          EOF

          echo "Wrote request.json:"
          cat .validation/input/request.json

      - name: Run Interface Validator Agent (repo-pinned)
        shell: bash
        run: |
          set -euo pipefail

          echo "Running interface-validator agent (repo-pinned)"
          claude agents/interface-validator.md \
            "Validate UI using input file .validation/input/request.json"

      # Commit ONLY the evidence folder for this run, safely
      - name: Commit validation evidence (safe pull)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Always sync first (prevents fetch-first errors on concurrent runs)
          git fetch origin main
          git pull --rebase origin main

          # Add only this runâ€™s evidence folder (avoid committing .validation)
          git add "${{ env.EVID_DIR }}"

          if git diff --cached --quiet; then
            echo "No evidence changes to commit."
            exit 0
          fi

          git commit -m "Interface validation evidence: ${{ github.event.inputs.feature_name }} (run ${{ github.run_id }})"
          git push origin main
