name: Interface Validation (Pure Agent, Anthropic Safe)

on:
  workflow_dispatch:
    inputs:
      feature_name:
        description: "Feature name to validate"
        required: true
        type: string
      claims_json:
        description: "Claims to validate (JSON string)"
        required: true
        type: string
      navigation_paths_json:
        description: "Navigation paths (JSON string)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  validate-interface:
    runs-on: self-hosted

    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # (Optional but recommended) avoid push/pull conflicts before we create files
      - name: Sync main (safe pull)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull --rebase origin main || true

      - name: Verify Anthropic key present (safe)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
            echo "❌ ANTHROPIC_API_KEY is EMPTY. Ensure repo secret 'ANTHROPIC_API_KEY' exists."
            exit 1
          fi
          echo "✅ Key present (len=${#ANTHROPIC_API_KEY})"

      # Normalize to remove accidental \r or \n characters (common when copying)
      - name: Normalize Anthropic key (strip CR/LF)
        shell: bash
        run: |
          set -euo pipefail
          ANTHROPIC_API_KEY="$(printf '%s' "$ANTHROPIC_API_KEY" | tr -d '\r\n')"
          export ANTHROPIC_API_KEY
          echo "✅ Normalized key length=${#ANTHROPIC_API_KEY}"

      # Your requested diagnostic block (prints only length + a few chars, not full key)
      - name: Debug API Key in GitHub Actions (diagnostic + real API call)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== API Key Diagnostics ==="
          echo "Key length: ${#ANTHROPIC_API_KEY}"
          echo "Key starts with sk-ant: $(echo "${ANTHROPIC_API_KEY}" | grep -q '^sk-ant' && echo 'YES' || echo 'NO')"
          echo "First 10 chars: ${ANTHROPIC_API_KEY:0:10}"
          echo "Last 10 chars:  ${ANTHROPIC_API_KEY: -10}"

          HTTP_CODE=$(curl -sS -o /tmp/anthropic_diag.json -w "%{http_code}" \
            https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-3-5-haiku-latest",
              "max_tokens": 5,
              "messages": [{"role":"user","content":"hi"}]
            }')

          echo "Anthropic HTTP status: ${HTTP_CODE}"
          cat /tmp/anthropic_diag.json || true

          if [ "${HTTP_CODE}" != "200" ]; then
            echo "❌ API call failed"
            exit 1
          fi

          echo "✅ API call succeeded"

      - name: Verify Claude Code CLI available
        shell: bash
        run: |
          set -euo pipefail
          which claude
          claude --version | tee /tmp/claude_version.txt
          grep -q "Claude Code" /tmp/claude_version.txt || {
            echo "❌ Claude Code CLI required. Install on runner:"
            echo "   npm uninstall -g claude || true"
            echo "   npm install -g @anthropic-ai/claude-code"
            exit 1
          }

      - name: Ensure jq is installed
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "✅ jq is installed"
            jq --version
            exit 0
          fi

          echo "jq not found. Installing..."
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          elif command -v brew >/dev/null 2>&1; then
            brew install jq
          else
            echo "❌ Could not install jq automatically. Please install jq on the self-hosted runner."
            exit 1
          fi
          jq --version

      - name: Write validation input JSON (safe)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .validation/input

          CLAIMS_RAW='${{ github.event.inputs.claims_json }}'
          NAV_RAW='${{ github.event.inputs.navigation_paths_json }}'
          [ -z "${NAV_RAW}" ] && NAV_RAW='[]'

          echo "${CLAIMS_RAW}" | jq -e . >/dev/null
          echo "${NAV_RAW}" | jq -e . >/dev/null

          jq -n \
            --arg feature_name '${{ github.event.inputs.feature_name }}' \
            --argjson claims_to_validate "${CLAIMS_RAW}" \
            --argjson navigation_paths "${NAV_RAW}" \
            '{
              feature_name: $feature_name,
              claims_to_validate: $claims_to_validate,
              navigation_paths: $navigation_paths
            }' > .validation/input/request.json

          echo "Wrote request.json:"
          cat .validation/input/request.json

      - name: Run Interface Validator Agent (PURE, STRICT JSON)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .validation/output

          INPUT_JSON="$(cat .validation/input/request.json)"

          # ✅ CRITICAL: heredoc content is indented by 10 spaces (same as other run lines),
          # so YAML will NOT attempt to parse "SYSTEM (NON-NEGOTIABLE)" as YAML.
          cat > .validation/output/agent_prompt.txt <<'__AGENT_PROMPT__'
          SYSTEM (NON-NEGOTIABLE)

          You are InterfaceValidatorAgent.
          You are NOT a general assistant.

          - Do NOT greet.
          - Do NOT ask questions.
          - Do NOT offer unrelated help.
          - Do NOT execute UI. (Logic-only validation.)
          - Output MUST be exactly one valid JSON object.
          - No markdown.
          - No backticks.
          - No prose.

          If required input is missing or invalid:
          Return:
          { "status": "error", "reason": "invalid_input" }

          TASK

          Given INPUT_JSON containing:
          - feature_name (string)
          - claims_to_validate (array)
          - navigation_paths (array)

          You MUST:
          1. Validate each claim logically (no UI execution)
          2. Produce deterministic validation results
          3. Output strictly valid JSON

          OUTPUT SCHEMA (MANDATORY)

          {
            "status": "ok",
            "feature_name": string,
            "validated_claims": array,
            "summary": string
          }
          __AGENT_PROMPT__

          # Run Claude with the prompt + INPUT_JSON appended
          claude -p --output-format text \
            "$(cat .validation/output/agent_prompt.txt)

          INPUT_JSON:
          ${INPUT_JSON}
          " > .validation/output/result.json

          echo "Saved: .validation/output/result.json"
          cat .validation/output/result.json

          # Validate JSON output shape quickly
          jq -e 'type=="object"' .validation/output/result.json >/dev/null
          jq -e '.status and .feature_name and (.validated_claims|type=="array") and .summary' .validation/output/result.json >/dev/null
          echo "✅ Output is valid JSON and matches required schema"

      - name: Commit validation output
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .validation || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Interface validation: ${{ github.event.inputs.feature_name }}"
          git push
