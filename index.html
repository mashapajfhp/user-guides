<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bayzat User Guides</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      line-height: 1.6;
      color: #1a1a2e;
      background: #f8f9ff;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #6B46C1 0%, #805AD5 50%, #9F7AEA 100%);
      color: #fff;
      padding: 60px 40px 50px;
      text-align: center;
    }
    .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 12px; }
    .header p { font-size: 1.15rem; opacity: 0.92; max-width: 600px; margin: 0 auto; }
    .stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 28px;
    }
    .stat { text-align: center; }
    .stat-number { font-size: 2rem; font-weight: 700; }
    .stat-label { font-size: 0.85rem; opacity: 0.85; text-transform: uppercase; letter-spacing: 0.05em; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
    .search-bar {
      margin: -28px auto 32px;
      max-width: 560px;
      position: relative;
    }
    .search-bar input {
      width: 100%;
      padding: 16px 20px 16px 48px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      outline: none;
      transition: border-color 0.2s;
    }
    .search-bar input:focus { border-color: #6B46C1; }
    .search-bar svg {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      width: 20px;
      height: 20px;
    }
    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 32px;
    }
    .cat-btn {
      padding: 8px 18px;
      border-radius: 20px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #475569;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .cat-btn:hover, .cat-btn.active {
      background: #6B46C1;
      color: #fff;
      border-color: #6B46C1;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      padding-bottom: 60px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 24px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(107,70,193,0.12);
      border-color: #6B46C1;
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    .card-title { font-size: 1.1rem; font-weight: 600; color: #1a1a2e; }
    .card-version {
      font-size: 0.75rem;
      color: #6B46C1;
      background: #f3e8ff;
      padding: 2px 8px;
      border-radius: 6px;
      font-weight: 500;
      margin-left: auto;
    }
    .card-desc {
      font-size: 0.88rem;
      color: #64748b;
      flex: 1;
      margin-bottom: 16px;
    }
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag {
      font-size: 0.72rem;
      color: #6B46C1;
      background: #faf5ff;
      padding: 3px 10px;
      border-radius: 12px;
      border: 1px solid #e9d5ff;
    }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid #f1f5f9;
    }
    .card-audience {
      font-size: 0.78rem;
      color: #94a3b8;
      font-weight: 500;
    }
    .card-arrow {
      color: #6B46C1;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .footer {
      text-align: center;
      padding: 32px;
      color: #94a3b8;
      font-size: 0.85rem;
      border-top: 1px solid #e2e8f0;
      background: #fff;
    }
    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
      font-size: 1.1rem;
      grid-column: 1 / -1;
    }
    .loading {
      text-align: center;
      padding: 80px 20px;
      color: #94a3b8;
      font-size: 1.1rem;
      grid-column: 1 / -1;
    }
    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid #e2e8f0;
      border-top-color: #6B46C1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .bg-payroll { background: #ecfdf5; }
    .bg-time { background: #eff6ff; }
    .bg-people { background: #fef3c7; }
    .bg-performance { background: #fce7f3; }
    .bg-settings { background: #f3e8ff; }
    .bg-security { background: #fee2e2; }
    .bg-automation { background: #e0f2fe; }
    .bg-default { background: #f1f5f9; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Bayzat User Guides</h1>
    <p>Comprehensive guides for every feature on the Bayzat HR platform. Find step-by-step instructions, screenshots, and best practices.</p>
    <div class="stats">
      <div class="stat">
        <div class="stat-number" id="guide-count">-</div>
        <div class="stat-label">Guides</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="cat-count">-</div>
        <div class="stat-label">Categories</div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="search-bar">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
      <input type="text" id="search" placeholder="Search guides by name or keyword..." autocomplete="off">
    </div>

    <div class="categories" id="categories">
      <button class="cat-btn active" data-cat="all">All</button>
    </div>

    <div class="grid" id="grid">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div>Loading guides...</div>
      </div>
    </div>
  </div>

  <div class="footer" id="footer">Loading...</div>

  <script>
    // === Supabase read-only access ===
    var SUPABASE_URL = "https://wliqznyleighuggvtidj.supabase.co";
    var SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsaXF6bnlsZWlnaHVnZ3Z0aWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODg4NDksImV4cCI6MjA3ODk2NDg0OX0.VsoY-dYVxfntIEZcXYHtkm4uZ493d5aNDTC9yLiMBEE";

    // Category display labels and background classes
    var CAT_LABELS = {
      payroll: "Payroll", time: "Time & Attendance", people: "People",
      performance: "Performance", requests: "Requests", settings: "Settings",
      security: "Security", automation: "Automation", other: "Other"
    };
    var CAT_BG = {
      payroll: "bg-payroll", time: "bg-time", people: "bg-people",
      performance: "bg-performance", requests: "bg-people", settings: "bg-settings",
      security: "bg-security", automation: "bg-automation", other: "bg-default"
    };

    // Parse content_summary for audience and tags
    function parseSummary(summary) {
      if (!summary) return { audience: "Admin", tags: [] };
      var lines = summary.split("\n");
      var audience = "Admin";
      var tags = [];
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.indexOf("Audience:") === 0) {
          var val = line.replace("Audience:", "").trim().toLowerCase();
          audience = val === "both" ? "Admin & Employee" : val === "admin" ? "Admin" : "Admin & Employee";
        }
        if (line.indexOf("Also known as:") === 0) {
          tags = line.replace("Also known as:", "").trim()
            .split(",").map(function(t){ return t.trim(); })
            .filter(function(t){ return t.length > 0 && t.length < 30; }).slice(0, 4);
        }
      }
      return { audience: audience, tags: tags };
    }

    var grid = document.getElementById("grid");
    var searchInput = document.getElementById("search");
    var categoriesDiv = document.getElementById("categories");
    var guides = [];
    var activeCategory = "all";

    function render(filter, cat) {
      filter = filter || "";
      cat = cat || "all";
      var q = filter.toLowerCase();
      var filtered = guides.filter(function(g) {
        var matchCat = cat === "all" || g.cat === cat;
        var matchSearch = !q ||
          g.name.toLowerCase().indexOf(q) !== -1 ||
          g.sdesc.toLowerCase().indexOf(q) !== -1 ||
          g.tags.some(function(t){ return t.toLowerCase().indexOf(q) !== -1; }) ||
          (g.allAliases && g.allAliases.toLowerCase().indexOf(q) !== -1);
        return matchCat && matchSearch;
      });

      if (filtered.length === 0) {
        grid.innerHTML = '<div class="no-results">No guides match your search.</div>';
        return;
      }

      grid.innerHTML = filtered.map(function(g) {
        return '<a class="card" href="' + g.url + '" data-cat="' + g.cat + '">' +
          '<div class="card-header">' +
            '<div class="card-icon ' + g.bg + '">' + g.icon + '</div>' +
            '<div class="card-title">' + g.name + '</div>' +
            '<span class="card-version">v' + g.version + '</span>' +
          '</div>' +
          '<div class="card-desc">' + g.sdesc + '</div>' +
          '<div class="card-tags">' + g.tags.map(function(t){ return '<span class="tag">' + t + '</span>'; }).join("") + '</div>' +
          '<div class="card-footer">' +
            '<span class="card-audience">' + g.audience + '</span>' +
            '<span class="card-arrow">&rarr;</span>' +
          '</div>' +
        '</a>';
      }).join("");
    }

    function buildCategoryButtons() {
      var cats = {};
      guides.forEach(function(g){ cats[g.cat] = true; });
      var html = '<button class="cat-btn active" data-cat="all">All</button>';
      for (var key in CAT_LABELS) {
        if (cats[key]) html += '<button class="cat-btn" data-cat="' + key + '">' + CAT_LABELS[key] + '</button>';
      }
      categoriesDiv.innerHTML = html;
    }

    async function loadGuides() {
      try {
        var res = await fetch(
          SUPABASE_URL + "/rest/v1/user_guides?select=feature_slug,feature_name,version,access_url,content_summary,category,icon,short_description&status=eq.completed&order=feature_name.asc",
          { headers: { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + SUPABASE_KEY } }
        );
        if (!res.ok) throw new Error("HTTP " + res.status);
        var rows = await res.json();

        guides = rows.map(function(row) {
          var parsed = parseSummary(row.content_summary);
          var cat = row.category || "other";
          var allAliases = row.content_summary
            ? (row.content_summary.match(/Also known as:\s*(.+)/) || [])[1] || ""
            : "";
          return {
            slug: row.feature_slug,
            name: row.feature_name,
            version: row.version,
            url: row.access_url,
            cat: cat,
            icon: row.icon || "ðŸ“–",
            bg: CAT_BG[cat] || "bg-default",
            sdesc: row.short_description || row.feature_name + " user guide.",
            audience: parsed.audience,
            tags: parsed.tags,
            allAliases: allAliases
          };
        });

        document.getElementById("guide-count").textContent = guides.length;
        var catSet = {};
        guides.forEach(function(g){ catSet[g.cat] = true; });
        document.getElementById("cat-count").textContent = Object.keys(catSet).length;
        document.getElementById("footer").innerHTML = "Powered by Supabase &middot; " + guides.length + " guides &middot; auto-updates when new guides are published";

        buildCategoryButtons();
        render();

        categoriesDiv.addEventListener("click", function(e) {
          if (!e.target.classList.contains("cat-btn")) return;
          categoriesDiv.querySelectorAll(".cat-btn").forEach(function(b){ b.classList.remove("active"); });
          e.target.classList.add("active");
          activeCategory = e.target.dataset.cat;
          render(searchInput.value, activeCategory);
        });

      } catch (err) {
        console.error("Failed to load guides:", err);
        grid.innerHTML = '<div class="no-results">Failed to load guides. Please refresh the page.</div>';
      }
    }

    searchInput.addEventListener("input", function() { render(searchInput.value, activeCategory); });
    loadGuides();
  </script>
</body>
</html>
